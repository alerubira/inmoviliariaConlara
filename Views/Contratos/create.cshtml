@model Inmobiliaria.Models.Contratos
@using Inmobiliaria.Models
@using System.Collections.Generic
@{
    ViewData["Title"] = "Create";
   // var tiposInmuebles = (IList<TipoInmueble>)ViewBag.TipoInmuebles;
}

<h4>Nuevo Contrato</h4>
<hr />
<div class="row">
    <div class="col-md-4 bg-white p-3 border rounded shadow-sm">
        <form asp-action="Create">
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>
           
           
            <div class="form-group">
                    <label class="control-label">Inquilino</label>
                    <input type="text" id="inquilinoInput" class="form-control" placeholder="Busque por apellido" list="inquilinosList" autocomplete="off" />
                    <datalist id="inquilinosList"></datalist>
                    <!-- Campo oculto para enviar el ID -->
                    <input type="hidden" id="IdInquilino" name="IdInquilino" />
                    <p id="pNoEncontradoInquilino"class="text-danger"></p>
            </div>

                        <script>
                            document.getElementById("inquilinoInput").addEventListener("input", function () {
                                let valor = this.value;
                                let pNoEncontrado = document.getElementById("pNoEncontradoInquilino");
                                pNoEncontrado.textContent = ""; // Limpiar mensaje de no encontrado
                                if (valor.length >= 3&&valor.length<6) {
                                    fetch(`/Inquilinos/BuscarInquilinoPorFraccionApellido?term=${valor}`)
                                        .then(r => r.json())
                                        .then(data => {
                                            let dl = document.getElementById("inquilinosList");
                                            dl.innerHTML = "";

                                            if (data.success) {
                                                
                                                data.data.forEach(p => {
                                                    let option = document.createElement("option");
                                                    option.value = p.texto;   // se muestra Nombre Apellido (DNI)
                                                    option.dataset.id = p.id; // guardamos el ID
                                                    dl.appendChild(option);
                                                });
                                            }else{
                                                pNoEncontrado.textContent =data.message;
                                            }
                                        });
                                }
                            });

                            document.getElementById("inquilinoInput").addEventListener("change", function () {
                                let valor = this.value;
                                let dl = document.getElementById("inquilinosList").options;
                                for (let i = 0; i < dl.length; i++) {
                                    if (dl[i].value === valor) {
                                        document.getElementById("IdInquilino").value = dl[i].dataset.id;
                                    }
                                }
                            });
                        </script>
            <div class="form-group">
            <label class="control-label">Inmueble</label>
            <input type="text" id="inmuebleInput" class="form-control" placeholder="Busque por direccion" list="inmueblesList" autocomplete="off" />
            <datalist id="inmueblesList"></datalist>
            <!-- Campo oculto para enviar el ID -->
            <input type="hidden" id="IdInmuebles" name="IdInmuebles" />
            <p id="pNoEncontradoDomicilio"class=text-danger></p>
            </div>

                        <script>
                            document.getElementById("inmuebleInput").addEventListener("input", function () {
                                let valor = this.value;
                                let pNoEncontrado=document.getElementById("pNoEncontradoDomicilio");
                                pNoEncontrado.textContent=""; // Limpiar mensaje de no encontrado
                                if (valor.length >= 3&&valor.length<6) {
                                    fetch(`/Inmuebles/BuscarInmueblePorFraccionDireccion?term=${valor}`)
                                        .then(r => r.json())
                                        .then(data => {
                                            let dl = document.getElementById("inmueblesList");
                                            dl.innerHTML = "";

                                            if (data.success) {
                                                console.log(data.data);
                                                data.data.forEach(p => {
                                                    let option = document.createElement("option");
                                                    option.value = p.direccion;   // se muestra direccion
                                                    option.dataset.id = p.id; // guardamos el ID
                                                    option.dataset.precio = p.precio; // guardamos el precio
                                                    
                                                   
                                                    dl.appendChild(option);
                                                });
                                            }else{
                                                pNoEncontrado.textContent =data.message;
                                            }
                                        });
                                }
                            });

                            document.getElementById("inmuebleInput").addEventListener("change", function () {
                                let valor = this.value;
                                let dl = document.getElementById("inmueblesList").options;
                                for (let i = 0; i < dl.length; i++) {
                                    if (dl[i].value === valor) {
                                        document.getElementById("IdInmuebles").value = dl[i].dataset.id;
                                        document.getElementById("precio").value = dl[i].dataset.precio;
                                        document.getElementById("Monto").value = dl[i].dataset.precio;
                                    }
                                }
                            });
                        </script>
             <div class="form-group">
                <label asp-for="Monto" class="control-label"></label>
                <input asp-for="Monto" class="form-control" readonly/>
                <span asp-validation-for="Monto" class="text-danger"></span>
                 <input type="hidden" id="precio" name="precio" />
            </div>  
             <div class="form-group">
                <label asp-for="CantidadCuotas" class="control-label"></label>
                <input asp-for="CantidadCuotas" class="form-control" readonly/>
                <span asp-validation-for="CantidadCuotas" class="text-danger"></span>
                
            </div> 
             <div class="form-group">
                <label asp-for="CuotasPagas" class="control-label"></label>
                <input asp-for="CuotasPagas" class="form-control" readonly/>
                <span asp-validation-for="CuotasPagas" class="text-danger"></span>
             <div class="form-group">
                <label asp-for="FechaDesde" class="control-label"></label>
                <input asp-for="FechaDesde" class="form-control" />
                <span asp-validation-for="FechaDesde" class="text-danger"></span>
                  <input type="hidden" id="mesInicio" name="MesInicio" />
            </div>
            <div class="form-group">
                <label asp-for="FechaHasta" class="control-label"></label>
                <input asp-for="FechaHasta" class="form-control" />
                <span asp-validation-for="FechaHasta" class="text-danger"></span>
            </div>
            <script>
                        function calcularMeses() {
                            const desde = document.getElementById("FechaDesde").value;
                            const hasta = document.getElementById("FechaHasta").value;
                            if (desde && hasta) 
                            {
                                const fechaDesde = new Date(desde);
                                const fechaHasta = new Date(hasta);
                                let meses = (fechaHasta.getFullYear() - fechaDesde.getFullYear()) * 12;
                                meses += fechaHasta.getMonth() - fechaDesde.getMonth();
                                meses += 1; // incluir ambos meses
                                if (meses < 0) meses = 0;
                                precio=document.getElementById("precio").value;
                               // monto=precio*meses;
                               document.getElementById("Monto").value = precio;
                                document.getElementById("CantidadCuotas").value = meses;
                                document.getElementById("CuotasPagas").value = 0;
                                document.getElementById("mesInicio").value = fechaDesde.getMonth()+1;
                            } else {
                                document.getElementById("Monto").value = "";
                            }
                        }

                        document.getElementById("FechaDesde").addEventListener("change", calcularMeses);
                        document.getElementById("FechaHasta").addEventListener("change", calcularMeses);
            </script>          
            <div class="form-group">
                <input type="submit" value="Create" class="btn btn-primary" />
            </div>
        </form>
    </div>
</div>

<div>
    <a asp-action="Index">Regresar a la lista</a>
</div>